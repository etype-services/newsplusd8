<?php

use Drupal\user\Entity\User;
use Drupal\node\Entity\Node;

/**
 * {@inheritdoc}
 */
function etype_e_editions() {

  $logged_in = Drupal::currentUser()->isAuthenticated();
  $config = Drupal::config('etype.adminsettings');
  $e_edition = $config->get('etype_e_edition');
  $pub = $config->get('etype_pub');
  $ptype = $config->get('etype_ptype');

  $config = Drupal::config('system.site');
  $site = $config->get('name');

  /* because Lutcher has a comma */
  if (strpos($e_edition, '|') !== false) {
    $items = explode(',', $e_edition);
    $pubs = explode(',', $pub);
    $ptypes = explode(',', $ptype);
  } else {
    $items = [$e_edition];
    $pubs = [$pub];
    $ptypes = [$ptype];
  }

  $e_editions = [];
  $ptr = 0;
  foreach ($items as $item) {
    $arr = explode('|', $item);
    if (isset($arr[1])) {
      $site = trim($arr[1]);
    }

    $ar2 = preg_split("/ID[0-9]+/", $arr[0]); // make LandingImage directory name
    $imagedir = trim($ar2[0]);
    $e_editions[$ptr]['image'] = 'https://etypeservices.com/LandingPageImages/' . $imagedir . '/currentpg1.jpg';

    if (isset($pubs[$ptr])) {
      $pub = trim($pubs[$ptr]);
    }
    if (isset($ptypes[$ptr])) {
      $ptype = trim($ptypes[$ptr]);
    }
    $e_edition = trim($arr[0]);

    if ($logged_in > 0) {
      if (!empty ($pub)) {
        $account = Drupal\user\Entity\User::load(Drupal::currentUser()->id());
        $name = $account->get('name')->value;
        $path = 'https://etypeservices.com/ReadTheEdition.aspx?Username=' . $name . "&Pub=" . $pub . "&PType=" . $ptype;
      } else {
        $path = 'https://etypeservices.com/' . $e_edition . '/';
      }
    } else {
      $path = 'https://etypeservices.com/' . $e_edition . '/';
    }

    $e_editions[$ptr]['site_name'] = trim($site);
    $e_editions[$ptr]['path'] = $path;
    $ptr++;
  }
  return $e_editions;
}

/**
 * {@inheritdoc}
 */
function etype_menu_links_discovered_alter(&$links) {
  $e_editions = etype_e_editions();
  $links['etype.e_edition']['url'] = $e_editions[0]['path'];
}

/**
 * Split string on word boundary.
 *
 * {@inheritdoc}
 */
function substrwords($text, $maxchar, $end='...') {
  if (strlen($text) > $maxchar || $text == '') {
    $words = preg_split('/\s/', $text);
    $output = '';
    $i      = 0;
    while (1) {
      $length = strlen($output)+strlen($words[$i]);
      if ($length > $maxchar) {
        break;
      }
      else {
        $output .= " " . $words[$i];
        ++$i;
      }
    }
    $output .= $end;
  }
  else {
    $output = $text;
  }
  return $output;
}

/**
 * Implements hook_form_alter().
 */
function etype_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'node_article_edit_form') {
    $nid = $form_state->getformObject()->getEntity()->id();
    $node = Node::load($nid);
    $node_uid = $node->getOwnerId();
    $config = Drupal::config('etype.adminsettings');
    $uid = $config->get('author');
    if ($uid > 0 && $node_uid == 1) {
      $author = User::load($uid);
      $name = $author->getAccountName();
      $form['#attached']['drupalSettings']['etype']['author'] = $name .  ' (' . $uid . ')';
      $form['#attached']['library'][] = 'etype/etype';
    }
  }
}
